[
  ~[tlist_sql;
    SELECT
      CASE
      WHEN to_char(test.description) IS NULL
        THEN 'null'
      ELSE '"' || to_char(test.description) || '"' END,
      CASE
      WHEN test.name IS NULL
        THEN 'null'
      ELSE to_char(test.name) END,
      CASE
      WHEN row_number()
           OVER (
             ORDER BY NULL) = count(*)
           OVER ()
        THEN ''
      ELSE ','
      END AS comma
    FROM (
           SELECT
             pgfinalgrades.finalgradename                                          AS description,
             round(sum(pgfinalgrades.gpascore) / count(pgfinalgrades.gpascore), 2) AS name
           FROM (
                  SELECT
                    id,
                    grade,
                    studentid,
                    sectionid,
                    finalgradename,
                    CASE grade
                    WHEN 'A+'
                      THEN 4
                    WHEN 'A'
                      THEN 4
                    WHEN 'A-'
                      THEN 3.7
                    WHEN 'B+'
                      THEN 3.3
                    WHEN 'B'
                      THEN 3
                    WHEN 'B-'
                      THEN 2.7
                    WHEN 'C+'
                      THEN 2.3
                    WHEN 'C'
                      THEN 2
                    WHEN 'C-'
                      THEN 1.7
                    WHEN 'D+'
                      THEN 1.3
                    WHEN 'D'
                      THEN 1
                    WHEN 'D-'
                      THEN 0.7
                    WHEN 'F'
                      THEN 0
                    ELSE NULL END gpascore
                  FROM pgfinalgrades) pgfinalgrades
             JOIN sections ON pgfinalgrades.sectionid = sections.id
             JOIN courses ON courses.course_number = sections.course_number
             JOIN terms ON terms.id = sections.termid
           WHERE pgfinalgrades.studentid = (
             SELECT id
             FROM students
             WHERE dcid = ~(gpv.students_dcid)) AND
                 CASE pgfinalgrades.grade
                 WHEN 'A+'
                   THEN 4
                 WHEN 'A'
                   THEN 4
                 WHEN 'A-'
                   THEN 3.7
                 WHEN 'B+'
                   THEN 3.3
                 WHEN 'B'
                   THEN 3
                 WHEN 'B-'
                   THEN 2.7
                 WHEN 'C+'
                   THEN 2.3
                 WHEN 'C'
                   THEN 2
                 WHEN 'C-'
                   THEN 1.7
                 WHEN 'D+'
                   THEN 1.3
                 WHEN 'D'
                   THEN 1
                 WHEN 'D-'
                   THEN 0.7
                 WHEN 'F'
                   THEN 0
                 ELSE NULL END IS NOT NULL
                 AND terms.yearid = ~(gpv.yearid)
           GROUP BY terms.yearid, pgfinalgrades.finalgradename
           ORDER BY finalgradename) test]
    {
      "term": ~(term),
      "gpa": ~(gpa)
    }~(comma)
  [/tlist_sql]
]
