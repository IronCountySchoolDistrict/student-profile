[
  ~[tlist_sql;
    WITH phones AS (
        SELECT
          contactdcid,
          chr(91) ||
          listagg(
              chr(123) ||
              '"phone_number"' ||
              chr(58) ||
              CASE
              WHEN to_char(u_sc_phone.phone_number) IS NULL
                THEN 'null'
              ELSE '"' || to_char(u_sc_phone.phone_number) || '"'
              END || ',' ||
              '"phone_priority"' ||
              chr(58) ||
              CASE
              WHEN to_char(u_sc_phone.phone_priority) IS NULL
                THEN 'null'
              ELSE '"' || to_char(u_sc_phone.phone_priority) || '"'
              END || ',' ||
              '"phone_type"' ||
              chr(58) ||
              CASE
              WHEN to_char(u_sc_phone.phone_type) IS NULL
                THEN 'null'
              ELSE '"' || to_char(u_sc_phone.phone_type) || '"'
              END ||
              chr(125)
              , ',')
          WITHIN GROUP (
            ORDER BY contactdcid) || chr(93) AS phonejson

        FROM
          u_sc_phone
        WHERE
          u_sc_phone.studentsdcid = ~(gpv.students_dcid)
        GROUP BY
          contactdcid
    )
    SELECT
      u_student_contacts.id,
      CASE
      WHEN to_char(u_student_contacts.priority) IS NULL
        THEN 'null'
      ELSE to_char(u_student_contacts.priority) END,
      CASE
      WHEN to_char(u_student_contacts.employer) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.employer) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.legal_guardian) IS NULL
        THEN 'null'
      WHEN to_char(u_student_contacts.legal_guardian) = 1
        THEN 'true'
      WHEN to_char(u_student_contacts.legal_guardian) = 0
        THEN 'false'
      ELSE to_char(u_student_contacts.legal_guardian) END,
      CASE
      WHEN to_char(u_student_contacts.relationship) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.relationship) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.residence_street) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.residence_street) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.residence_city) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.residence_city) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.residence_state) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.residence_state) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.residence_zip) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.residence_zip) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.mailing_street) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.mailing_street) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.mailing_city) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.mailing_city) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.mailing_state) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.mailing_state) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.mailing_zip) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.mailing_zip) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.first_name) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.first_name) || '"' END,
      CASE
      WHEN to_char(u_student_contacts.last_name) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_student_contacts.last_name) || '"' END,
      CASE
      WHEN to_char(u_sc_email.email_address) IS NULL
        THEN 'null'
      ELSE '"' || to_char(u_sc_email.email_address) || '"' END,
      coalesce(phones.phonejson, chr(91) || chr(93)),
      CASE WHEN row_number()
                OVER (
                  ORDER BY NULL) = count(*)
                OVER ()
        THEN ''
      ELSE ',' END AS comma
    FROM
      u_student_contacts
      LEFT JOIN u_sc_email ON u_student_contacts.studentsdcid = u_sc_email.studentsdcid AND
                              u_student_contacts.id = u_sc_email.contactdcid
      LEFT JOIN phones ON u_student_contacts.id = phones.contactdcid
    WHERE
      u_student_contacts.studentsdcid = ~(gpv.students_dcid)
    ORDER BY
      u_student_contacts.legal_guardian DESC,
      u_student_contacts.priority ASC]
    {
      "id": ~(id),
      "priority": ~(priority),
      "employer": ~(employer),
      "legal_guardian": ~(legal_guardian),
      "relationship": ~(relationship),
      "residence_street": ~(residence_street),
      "residence_city": ~(residence_city),
      "residence_state": ~(residence_state),
      "residence_zip": ~(residence_zip),
      "mailing_street": ~(mailing_street),
      "mailing_city": ~(mailing_city),
      "mailing_state": ~(mailing_state),
      "mailing_zip": ~(mailing_zip),
      "first_name": ~(first_name),
      "last_name": ~(last_name),
      "email_address": ~(email_address),
      "phones": ~(phones)
    }~(comma)
  [/tlist_sql]
]
