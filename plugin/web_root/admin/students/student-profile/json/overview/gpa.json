[
  ~[tlist_sql;
  SELECT
    b.finalgradename,
    round(sum(b.gpascore) / count(*), 2) gpa
  FROM (SELECT
          id,
          grade,
          studentid,
          sectionid,
          finalgradename,
          CASE grade
          WHEN 'A+'
            THEN 4
          WHEN 'A'
            THEN 4
          WHEN 'A-'
            THEN 3.7
          WHEN 'B+'
            THEN 3.3
          WHEN 'B'
            THEN 3
          WHEN 'B-'
            THEN 2.7
          WHEN 'C+'
            THEN 2.3
          WHEN 'C'
            THEN 2
          WHEN 'C-'
            THEN 1.7
          WHEN 'D+'
            THEN 1.3
          WHEN 'D'
            THEN 1
          WHEN 'D-'
            THEN 0.7
          WHEN 'F'
            THEN 0
          ELSE NULL END gpascore
        FROM pgfinalgrades) b
    JOIN sections ON b.sectionid = sections.id
    JOIN courses ON courses.course_number = sections.course_number
    JOIN terms ON terms.id = sections.termid
  WHERE b.studentid = (select id from students where dcid=~[gpv:students_dcid]) AND
        CASE b.grade
        WHEN 'A+'
          THEN 4
        WHEN 'A'
          THEN 4
        WHEN 'A-'
          THEN 3.7
        WHEN 'B+'
          THEN 3.3
        WHEN 'B'
          THEN 3
        WHEN 'B-'
          THEN 2.7
        WHEN 'C+'
          THEN 2.3
        WHEN 'C'
          THEN 2
        WHEN 'C-'
          THEN 1.7
        WHEN 'D+'
          THEN 1.3
        WHEN 'D'
          THEN 1
        WHEN 'D-'
          THEN 0.7
        WHEN 'F'
          THEN 0
        ELSE NULL END IS NOT NULL
    and terms.yearid=~[gpv:yearid]
  GROUP BY terms.yearid, b.finalgradename;nonemessage=]
    {
      "~(finalgradename)": "~(gpa)"
    },
  [/tlist_sql]{}
]